<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Pago</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <?!= include('styles'); ?>
  <?!= include('JavaScript'); ?>
 

</head>

<body>

  <div class="theme-toggle">
    <button id="toggle-theme" aria-label="Toggle theme">
    <span id="theme-icon">ðŸŒž</span>
  </button>
  </div>

  <div class="container my-5">
    <div class="card p-4">
      <form id="myForm" class="needs-validation" novalidate onsubmit="handleFormSubmit(this)">
        <div class="row mb-4">
          <div class="col-md-6 text-center">
            <img src="https://drive.google.com/thumbnail?sz=w500&id=1prfzE2760WH6XZ9kG4k0VO5CdxJKiLNo" alt="Encabezado" class="img-fluid" style="max-width: 200px; filter: drop-shadow(0px 0px 15px #ffffff)">
          </div>
          <div class="col-md-6 d-flex align-items-center justify-content-center text-center">
            <h3 class="fw-bold mb-0">ASOCIACIÃ“N DE PROPIETARIOS Y VECINOS DE LA URBANIZACIÃ“N<br>SANTA FE III ETAPA</h3>
          </div>
        </div>

        <h1 class="h4 text-center receipt-title mb-5">REGISTRO DE PAGO</h1>

        <div class="row g-3">

          <div class="col-md-4">
            <div class="form-floating">
              <input type="number" class="form-control" id="idC" name="idC" placeholder="CÃ©dula" required>
              <label for="idC"><i class="bi bi-person-vcard"></i> CÃ©dula</label>
              <div class="invalid-feedback">Ingrese el nÃºmero de cÃ©dula</div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-floating">
              <input type="text" class="form-control" id="firstName" name="first_name" placeholder="Primer Nombre" required>
              <label for="firstName"><i class="bi bi-person-vcard"></i> Primer nombre</label>
              <div class="invalid-feedback">Ingrese el primer nombre</div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-floating">
              <input type="text" class="form-control" id="lastName" name="last_name" placeholder="Apellido" required>
              <label for="lastName"><i class="bi bi-person-vcard"></i> Primer apellido</label>
              <div class="invalid-feedback">Ingrese el primer apellido</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-floating">
              <input type="tel" class="form-control" id="phone" name="phone" placeholder="TelÃ©fono" required>
              <label for="phone"><i class="bi bi-whatsapp"></i> TelÃ©fono</label>
              <div class="invalid-feedback">Ingrese su nÃºmero de telÃ©fono</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-floating">
              <input type="email" class="form-control" id="email" name="email" placeholder="Correo" required>
              <label for="email"><i class="bi bi-envelope"></i> Correo electrÃ³nico</label>
              <div class="invalid-feedback">Ingrese un correo vÃ¡lido</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-floating">
              <select class="form-select" id="siteC" name="siteC" required>
              <option value="" disabled selected>Selecione una opcion</option>
              <option value="calle 83">Calle 83</option>
              <option value="calle 84b">Calle 84B</option>
              <option value="calle 84c">Calle 84C</option>
              <option value="calle 85b">Calle 85B</option>
              <option value="calle 85c">Calle 85C</option>
              <option value="calle 86b">Calle 86B</option>
              <option value="calle 86c">Calle 86C</option>
              <option value="calle 87b">Calle 87B</option>
              <option value="calle 87c">Calle 87C</option>
              <option value="calle 88b">Calle 88B</option>
              <option value="calle 88c">Calle 88C</option>
              <option value="calle 89b">Calle 89B</option>
              <option value="calle 89c">Calle 89C</option>
              <option value="calle 90b">Calle 90B</option>
              <option value="calle 90c">Calle 90C</option>
              <option value="calle 91c">Calle 91C</option>
            </select>
              <label for="siteC"><i class="bi bi-signpost"></i> NÃºmero de calle</label>
              <div class="invalid-feedback">Seleccione una calle</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-floating">
              <input type="text" class="form-control" id="siteN" name="siteN" placeholder="Casa" required>
              <label for="siteN"><i class="bi bi-house"></i> NÃºmero de casa</label>
              <div class="invalid-feedback">Ingrese el nÃºmero de casa</div>
            </div>
          </div>



          <div class="col-md-4">
            <div class="form-floating">
              <input type="text" class="form-control" id="ref" name="ref" placeholder="Referencia" required>
              <label for="ref"><i class="bi bi-bank"></i> Referencia de pago</label>
              <div class="invalid-feedback">Ingrese la referencia</div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-floating">
              <input type="date" class="form-control" id="dateOfPey" name="dateOfPey" required>
              <label for="dateOfPey"><i class="bi bi-calendar3"></i> Fecha de pago</label>
              <div class="invalid-feedback">Seleccione la fecha</div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-floating">
              <input type="number" class="form-control" id="monto" name="monto" placeholder="Monto" required>
              <label for="monto"><i class="bi bi-currency-dollar"></i> Monto</label>
              <div class="invalid-feedback">Ingrese el monto</div>
            </div>
          </div>

          <div class="col-md-12">
            <fieldset class="border rounded p-3">
              <legend class="float-none w-auto px-2 col-form-label-sm fw-normal"><i class="bi bi-cash-coin"></i> Tipo de
                Pago</legend>
              <div class="text-center" style="margin: -20px 0 -5px 0 !important;">
                <div class="form-check form-check-inline">
                  <input class="btn-check" type="checkbox" id="pagoTotal" name="tipoPago" autocomplete="off">
                  <label class="btn btn-outline-success" for="pagoTotal">TOTAL</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="btn-check" type="checkbox" id="pagoAbono" name="tipoPago" autocomplete="off">
                  <label class="btn btn-outline-primary" for="pagoAbono">ABONO</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="btn-check" type="checkbox" id="pagoDeuda" name="tipoPago" autocomplete="off">
                  <label class="btn btn-outline-secondary" for="pagoDeuda">DEUDA</label>
                </div>
                <div id="tipoPagoFeedback" class="invalid-feedback d-none">
                  <span>Seleccione al menos un tipo de pago</span>
                </div>
              </div>
            </fieldset>
          </div>

          <div class="col-12">
            <label for="formFileLg" class="form-label">Comprobante de pago</label>
            <input class="form-control form-control-lg" type="file" id="formFileLg" name="myFile" required onchange="previewImage()">
            <div class="invalid-feedback">Seleccione un archivo</div>
          </div>

          <div class="col-12 text-center mt-4">
            <button class="btn btn-primary btn-lg w-50" type="submit" id="submitBtn" disabled>Enviar</button>
          </div>

          <div class="col-12 text-center mt-3">
            <img id="imagePreview" src="https://drive.google.com/thumbnail?sz=w100&id=1bG9Ih9hhr9TrvpjGu8TVtNN4evdBrigB" alt="PrevisualizaciÃ³n" class="img-fluid" />
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Ã‰xito</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
          <p class="mt-3">
            <a id="successUrl" href="#">Su pago fue registrado exitosamente. Â¿Desea dejar un comentario?</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap y ValidaciÃ³n -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', function () {
  const idCInput = document.getElementById('idC');

  idCInput.addEventListener('blur', function () {
    const idC = this.value.trim();
    if (!idC) return;

    google.script.run.withSuccessHandler(function (respuesta) {
      const campos = {
        firstName: document.getElementById('firstName'),
        lastName: document.getElementById('lastName'),
        phone: document.getElementById('phone'),
        email: document.getElementById('email'),
        siteC: document.getElementById('siteC'), // select
        siteN: document.getElementById('siteN')
      };

      if (respuesta.encontrado) {
        campos.firstName.value = respuesta.firstName || '';
        campos.lastName.value = respuesta.lastName || '';
        campos.phone.value = respuesta.phone || '';
        campos.email.value = respuesta.email || '';
        campos.siteN.value = respuesta.siteN || '';

        const valorSiteC = (respuesta.siteC || '').trim();
        let opcionExistente = Array.from(campos.siteC.options).find(opt => opt.value === valorSiteC);

        if (!opcionExistente && valorSiteC) {
          let nuevaOpcion = new Option(valorSiteC, valorSiteC, true, true);
          campos.siteC.appendChild(nuevaOpcion);
        }

        campos.siteC.value = valorSiteC;
        campos.siteC.setAttribute('data-readonly', 'true');
        campos.siteC.disabled = true; // para bloquear ediciÃ³n

        // poner campos de texto como readonly en lugar de disabled
        ['first_name', 'last_name', 'phone', 'email', 'siteN'].forEach(id => {
          if (campos[id]) {
            campos[id].readOnly = true;
          }
        });

      } else {
        for (let campo in campos) {
          if (!campos[campo]) continue;

          if (campos[campo].tagName === 'SELECT') {
            campos[campo].disabled = false;
            campos[campo].removeAttribute('data-readonly');
            campos[campo].selectedIndex = 0;
          } else {
            campos[campo].value = '';
            campos[campo].readOnly = false;
          }
        }
      }
    }).buscarOcupantePoridC(idC);
  });

  // Activar SELECTS antes de enviar el formulario para que se validen
  document.querySelector('form').addEventListener('submit', function () {
    const selects = this.querySelectorAll('select[data-readonly="true"]');
    selects.forEach(select => {
      select.disabled = false;
    });
  });
});







    // Activar el botÃ³n solo si el formulario estÃ¡ completo y vÃ¡lido
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('myForm');
  const submitBtn = document.getElementById('submitBtn');
  const inputs = form.querySelectorAll('input, select');
  const checkboxes = document.querySelectorAll('input[name="tipoPago"]');

  function validateForm() {
    let isValid = form.checkValidity();
    let hasChecked = Array.from(checkboxes).some(cb => cb.checked);

    submitBtn.disabled = !(isValid && hasChecked);
  }

  inputs.forEach(input => {
    input.addEventListener('input', validateForm);
    input.addEventListener('change', validateForm);
  });

  checkboxes.forEach(cb => cb.addEventListener('change', validateForm));
});


    (() => {
      'use strict';
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    })();

    function handleFormSubmit(formObject) {
      event.preventDefault();
      if (!formObject.checkValidity()) return;

      google.script.run
        .withSuccessHandler(updateUrl)
        .withFailureHandler(onFailure)
        .uploadFiles(formObject);
    }

    function updateUrl(url) {
      if (url && url.startsWith("http")) {
        document.getElementById("myForm").reset();
        document.getElementById("imagePreview").src = "https://drive.google.com/thumbnail?sz=w100&id=1bG9Ih9hhr9TrvpjGu8TVtNN4evdBrigB";
        document.getElementById("successUrl").href = url;
        new bootstrap.Modal(document.getElementById("successModal")).show();
      }
    }

    function onFailure(error) {
      document.getElementById("output").innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
    }

    function previewImage() {
      const file = document.getElementById('formFileLg').files[0];
      const preview = document.getElementById('imagePreview');
      const reader = new FileReader();
      reader.onload = () => preview.src = reader.result;
      if (file) reader.readAsDataURL(file);
    }

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('myForm');
      const checkboxes = document.querySelectorAll('input[name="tipoPago"]');
      const feedback = document.getElementById('tipoPagoFeedback');

      form.addEventListener('submit', function (event) {
        let checked = Array.from(checkboxes).some(cb => cb.checked);
        if (!checked) {
          feedback.classList.remove('d-none');
          feedback.classList.add('d-block');
          event.preventDefault();
          event.stopPropagation();
        } else {
          feedback.classList.remove('d-block');
          feedback.classList.add('d-none');
        }
        form.classList.add('was-validated');
      });

      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function () {
          if (Array.from(checkboxes).some(cb => cb.checked)) {
            feedback.classList.remove('d-block');
            feedback.classList.add('d-none');
          }
        });
      });
    });


   /* boton modo oscuro */ 
  const toggleBtn = document.getElementById('toggle-theme');
  const icon = document.getElementById('theme-icon');

  // Cargar preferencia guardada
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    icon.textContent = 'ðŸŒ™';
  }

  toggleBtn.addEventListener('click', () => {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) {
      document.documentElement.setAttribute('data-theme', 'light');
      localStorage.setItem('theme', 'light');
      icon.textContent = 'ðŸŒž';
    } else {
      document.documentElement.setAttribute('data-theme', 'dark');
      localStorage.setItem('theme', 'dark');
      icon.textContent = 'ðŸŒ™';
    }
  });

  </script>
</body>

</html>